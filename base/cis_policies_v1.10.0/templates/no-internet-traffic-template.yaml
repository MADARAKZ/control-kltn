apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: no-internet-traffic
  annotations:
    argocd.argoproj.io/sync-wave: '-1'
spec:
  crd:
    spec:
      names:
        kind: NoInternetTraffic
      validation:
        openAPIV3Schema:
          type: object
          properties:
            internet_cidr:
              type: string
              description: The CIDR range representing the internet (e.g., 0.0.0.0/0).  Any service exposing a port within this range is considered a violation.
  targets:
  - target: admission.k8s.gatekeeper.sh
    rego: "package nointernettraffic\n\nviolation[{\"msg\": msg}] {\n  input.kind.kind == \"Pod\"\n  not isAllowedPod(input.object)\n  msg := sprintf(\"Pod '%s' in namespace '%s' is not allowed to have internet traffic.\", [input.object.metadata.name, input.object.metadata.namespace])\n}\n\nviolation[{\"msg\": msg}] {\n  input.kind.kind == \"Service\"\n  not isAllowedService(input.object)\n  msg := sprintf(\"Service '%s' in namespace '%s' is not allowed to expose to internet traffic.\", [input.object.metadata.name, input.object.metadata.namespace])\n}\n\nviolation[{\"msg\": msg}] {\n  input.kind.kind == \"Deployment\"\n  not isAllowedDeployment(input.object)\n  msg := sprintf(\"Deployment '%s' in namespace '%s' is not allowed to have internet traffic.\", [input.object.metadata.name, input.object.metadata.namespace])\n}\n\nviolation[{\"msg\": msg}] {\n  input.kind.kind == \"StatefulSet\"\n  not isAllowedStatefulSet(input.object)\n  not isAllowedDeployment(input.object)\n  msg := sprintf(\"StatefulSet '%s' in namespace '%s' is not allowed to have internet traffic.\", [input.object.metadata.name, input.object.metadata.namespace])\n}\n\nviolation[{\"msg\": msg}] {\n  input.kind.kind == \"DaemonSet\"\n  not isAllowedDaemonSet(input.object)\n  msg := sprintf(\"DaemonSet '%s' in namespace '%s' is not allowed to have internet traffic.\", [input.object.metadata.name, input.object.metadata.namespace])\n}\n\nviolation[{\"msg\": msg}] {\n  input.kind.kind == \"Job\"\n  not isAllowedJob(input.object)\n  msg := sprintf(\"Job '%s' in namespace '%s' is not allowed to have internet traffic.\", [input.object.metadata.name, input.object.metadata.namespace])\n}\n\nviolation[{\"msg\": msg}] {\n  input.kind.kind == \"CronJob\"\n  not isAllowedCronJob(input.object)\n  msg := sprintf(\"CronJob '%s' in namespace '%s' is not allowed to have internet traffic.\", [input.object.metadata.name, input.object.metadata.namespace])\n}\n\nisAllowedPod(pod) {\n  not object.get(pod.spec, \"hostNetwork\", false)\n}\n\nisAllowedService(service) {\n  externalIPs := object.get(service.spec, \"externalIPs\", [])\n  not any(externalIPs, { ip | cidr.contains(input.parameters.internet_cidr, ip) })\n\n  type := object.get(service.spec, \"type\", \"ClusterIP\")\n  not (type == \"LoadBalancer\")\n\n  not hasExternalName(service)\n}\n\nhasExternalName(service) {\n    type := object.get(service.spec, \"type\", \"ClusterIP\")\n    type == \"ExternalName\"\n}\n\nisAllowedDeployment(deployment) {\n  containers := object.get(deployment.spec.template.spec, \"containers\", [])\n  not any(containers, notAllowedContainer)\n\n  initContainers := object.get(deployment.spec.template.spec, \"initContainers\", [])\n  not any(initContainers, notAllowedContainer)\n}\n\nisAllowedStatefulSet(statefulset) {\n  containers := object.get(statefulset.spec.template.spec, \"containers\", [])\n  not any(containers, notAllowedContainer)\n\n  initContainers := object.get(statefulset.spec.template.spec, \"initContainers\", [])\n  not any(initContainers, notAllowedContainer)\n}\n\nisAllowedDaemonSet(daemonset) {\n  containers := object.get(daemonset.spec.template.spec, \"containers\", [])\n  not any(containers, notAllowedContainer)\n\n  initContainers := object.get(daemonset.spec.template.spec, \"initContainers\", [])\n  not any(initContainers, notAllowedContainer)\n}\n\nisAllowedJob(job) {\n  containers := object.get(job.spec.template.spec, \"containers\", [])\n  not any(containers, notAllowedContainer)\n\n  initContainers := object.get(job.spec.template.spec, \"initContainers\", [])\n  not any(initContainers, notAllowedContainer)\n}\n\nisAllowedCronJob(cronjob) {\n  containers := object.get(cronjob.spec.jobTemplate.spec.template.spec, \"containers\", [])\n  not any(containers, notAllowedContainer)\n\n  initContainers := object.get(cronjob.spec.jobTemplate.spec.template.spec, \"initContainers\", [])\n  not any(initContainers, notAllowedContainer)\n}\n\nnotAllowedContainer(container) {\n  ports := object.get(container, \"ports\", [])\n  any(ports, isInternetPort)\n}\n\nisInternetPort(port) {\n  port.hostIP == input.parameters.internet_cidr\n}\n"
